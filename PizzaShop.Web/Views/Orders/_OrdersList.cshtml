@model PizzaShop.DataAccess.ViewModels.OrdersPageViewModel;
@{
    var PageSize = Model.Pagination.PageSize;
    var PageIndex = Model.Pagination.PageIndex;
    var TotalPage = Model.Pagination.TotalPage;
    var SearchString = Model.Pagination.SearchString;
    var TotalRecord = Model.Pagination.TotalRecord;
}

<div class="shadow card px-3">
    <section class="table-responsive">
        <table class="table table-hover user-table mb-0">
            <thead>
                <tr>
                    <th scope="col" class="d-flex align-items-center text-start">#Orders 
                        <i class="fa-solid fa-arrow-up mx-1 cursor-pointer sorting" data-type="ascending" data-name="Id"></i>
                        <i class="fa-solid fa-arrow-down cursor-pointer sorting" data-type="descending" data-name="Id"></i>
                    </th>
                    <th scope="col" class="text-center">
                        <div class="d-flex align-items-center justify-content-center">Date 
                            <i class="fa-solid fa-arrow-up mx-1 cursor-pointer sorting" data-type="ascending" data-name="Date"></i>
                            <i class="fa-solid fa-arrow-down cursor-pointer sorting" data-type="descending" data-name="Date"></i>
                        </div>
                    </th>
                    <th scope="col" class="text-center">
                        <div class="d-flex align-items-center justify-content-center">Customer 
                            <i class="fa-solid fa-arrow-up mx-1 cursor-pointer sorting" data-type="ascending" data-name="Customer"></i>
                            <i class="fa-solid fa-arrow-down cursor-pointer sorting" data-type="descending" data-name="Customer"></i>
                        </div>
                    </th>
                    <th scope="col" class="text-center">Status</th>
                    <th scope="col" class="d-flex justify-content-center">
                        <div style="width: 130px !important;" class="text-center w-100">Payment Mode</div>
                    </th>
                    <th scope="col" class="text-center"><div style="">Rating</div></th>
                    <th scope="col" class="">
                        <div  class="d-flex justify-content-end align-items-center">
                            <span style="width: 120px !important;">Total Amount</span>
                            <i class="fa-solid fa-arrow-up mx-1 cursor-pointer sorting" data-type="ascending" data-name="TotalAmount"></i>
                            <i class="fa-solid fa-arrow-down cursor-pointer sorting" data-type="descending" data-name="TotalAmount"></i>
                        </div>
                    </th>
                    <th scope="col" class="text-end">Action</th>
                </tr>
            </thead>

            <tbody class="table-group-devider">
                @if (@Model.OrdersList.Count() == 0)
                {
                    <tr>
                        <td colspan="7" class="text-center text-secondary">No Tables Found</td>
                    </tr>
                }
                @foreach (var o in @Model.OrdersList)
                {
                    <tr>
                        <td class="text-start">#@o.Id</td>
                        <td class="text-center">
                            <div class="">@o.Createddate</div>
                        </td>
                        <td class="text-center">@o.CustomerName</td>
                        <td class="text-center">@o.Status</td>
                        <td class="text-center">@o.PaymentMode</td>
                        <td class="text-center p-0">
                            <div class=" d-flex justify-content-center p-0">
                                <div class=" text-center">
                                    @if (o.Rating != null)
                                    {
                                        @for (var i = 0; i < Math.Ceiling((decimal)o.Rating); i++)
                                        {
                                            <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                                        }
                                        @for (var i = 0; i < 5 - Math.Ceiling((decimal)o.Rating); i++)
                                        {
                                            <i class="fa-regular fa-star" style="color: #FFD43B;"></i>
                                        }
                                    }

                                </div>
                            </div>
                        </td>
                        <td class="text-end">@o.Totalamount</td>
                        <td class="">
                            <span class="text-end d-flex justify-content-center align-items-center ">
                                @* <a href="@Url.Action("InvoiceDetail", "Orders", new { id = o.Id })"> *@
                                    <i class="fa-regular fa-file-pdf fs-5 me-2 text-secondary mt-1 getOrderPdf cursor-pointer"
                                    data-id="@o.Id"></i>
                                @* </a> *@
                                    <a href="@Url.Action("OrderDetails", "Orders", new { id = o.Id })" >
                                <i class="fa-solid fa-eye fs-5 text-secondary viewOrderDetails" data-id="@o.Id"></i></a>
                            </span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </section>
    <div class="d-flex justify-content-end justify-content-sm-end align-items-center my-2 p-2">
        <p class="mb-0 d-none d-md-block fs-6">Items Per page</p>
        <select class="mx-2 cursor-pointer" aria-label="Default select example" id="OrderPageSize">
            <option value="5" selected="@(PageSize == 5 ? true : false)">5</option>
            <option value="10" selected="@(PageSize == 10 ? true : false)">10</option>
            <option value="15" selected="@(PageSize == 15 ? true : false)">15</option>
        </select>

        <span class="mb-0 ms-2 me-2 d-none d-md-block" id="showing">Showing @(Math.Min(((PageIndex - 1) * PageSize) + 1,
            TotalRecord)) -
            @(Math.Min(PageIndex * PageSize, TotalRecord)) of @TotalRecord</span>
        @if (PageIndex > 1)
                {
        <span class="btn btn-outline-secondary me-1 px-3 py-0" name="PageIndex" id="PreviousOrders">
            <i class="fa-solid fa-less-than fa-sm"></i>
        </span>
                }
                else
        {
            <button class="btn btn-outline-secondary me-1 px-3 py-0" name="PageIndex" disabled>
                <i class="fa-solid fa-less-than fa-sm"></i>
            </button>
        }

        @if (PageIndex < TotalPage)
        {
            <a class="btn btn-outline-secondary px-3 py-0" name="PageIndex" id="NextOrders">
                <i class="fa-solid fa-greater-than fa-sm"></i>
            </a>
        }
        else
        {
            <button class="btn btn-outline-secondary px-3 py-0" name="PageIndex" disabled>
                <i class="fa-solid fa-greater-than fa-sm"></i>
            </button>
        }
    </div>
</div>


<div class="modal fade" id="deleteTaxModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Delete Confirmation</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="text-center">
                <i class="fa-solid fa-triangle-exclamation fa-2xl" style="color: #FFD43B;"></i>
            </div>
            <div class="modal-body text-center p-1">
                <p class="fw-bold mb-0">Are you sure you want to delete this Table?</p>
            </div>
            <div class="modal-footer d-flex justify-content-center border-0">
                <button type="button" class="btn btn-primary" id="confirmDeleteTaxBtn">Yes</button>
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>


<script>
    var OrderId;
    var OrderPageIndex = @PageIndex;
    var orderAjaxReq;
    var ToDate;
    var FromDate;

    function GetFilteredOrders() {
        var SearchString = $("#searchOrders").val();
        var pageSize = $("#OrderPageSize").val();
        var status = $("#statusDropDown").val();
        var time = $("#timeDropDown").val();

        if (orderAjaxReq && orderAjaxReq.readyState !== 4)
            orderAjaxReq.abort();

        orderAjaxReq = $.ajax({
            url: "/Orders/GetFilteredOrders",
            type: "GET",
            data: {
                pageIndex: OrderPageIndex,
                pageSize: pageSize,
                searchString: SearchString,
                fromDate: FromDate,
                toDate: ToDate,
                status: status,
                time: time,
                sortBy:SortBy,
                sortType: SortType
            },
            success: function (data) {
                $("#OrderListContainer").html(data);
            }
        })
    }


    $('#OrderPageSize').change(function () {
        var pageSize = @PageSize
        var pageIndex = 1
        GetFilteredOrders();
    })

    $("#PreviousOrders").click(function () {
        OrderPageIndex -= 1;
        GetFilteredOrders()
    })

    $('#NextOrders').click(function () {
        OrderPageIndex += 1;
        GetFilteredOrders()
    })

    $(".viewOrderDetails").click(function(){
        var id = $(this).data('id');
         
    })
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
    

    $(".getOrderPdf").click(function(){
        var id = $(this).data('id')
        $.ajax({
            url: "/Orders/InvoiceDetail",
            type: "GET",
            data: {
                id: id
            },
            success: function (response) {
                $("#InvoiceDetailContainer").html(response);
                const element = document.querySelector('#invoice-detail');
                const isMobile = window.innerWidth < 768;
        
                const options = {
                    margin: 1,
                    filename: 'OrderDetails.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: isMobile ? 3 : 2,
                        windowWidth: 800 
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                html2pdf().set(options).from(element).save();
            },
            error: function (error) {
                toastr.error("Error while download pdf file");
            }
        })
    })
</script>

